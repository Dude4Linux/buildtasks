#!/bin/bash -e

ARCHIVE=$(auto-apt-archive ubuntu)
LISTDIR=/etc/apt/sources.list.d

CURRENT_KERNEL=$(dpkg-query --showformat='${Package}\n' -W 'linux-image-2.6.*')

cp $LISTDIR/*.list /tmp/
sed -i "s|http://\(.*\)archive.ubuntu.com/ubuntu|$ARCHIVE|g" $LISTDIR/*.list

for actionfile in /etc/cron-apt/action.d/*; do
    while read aptcmd; do
        aptcmd=$(echo $aptcmd | sed "s|-q||")
        aptcmd=$(echo $aptcmd | sed "s|-o quiet=.*||")
        DEBIAN_FRONTEND=noninteractive apt-get $aptcmd
    done < $actionfile
done

if [[ $(dpkg-query -W 'linux-image-2.6.*' |wc -l) > 1 ]]; then
    DEBIAN_FRONTEND=noninteractive apt-get -y purge $CURRENT_KERNEL
fi

apt-get clean
rm -f /boot/*.bak
rm -f /var/cache/apt/*.bin
rm -f /var/lib/apt/lists/{archive.*,security.*}

mv /tmp/*.list $LISTDIR/


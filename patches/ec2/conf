#!/bin/sh -ex

install() {
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get -y \
        -o DPkg::Options::=--force-confdef \
        -o DPkg::Options::=--force-confold \
        install $@
}

# install ec2 required packages
install hubclient ebsmount

# link update-grub to update-grub-legacy-ec2
mv /usr/sbin/update-grub /usr/sbin/update-grub.orig
ln -s /usr/sbin/update-grub-legacy-ec2 /usr/sbin/update-grub

# fix grub
sed -i 's|root=/dev/hda1|root=/dev/xvda1|' /boot/grub/menu.lst
sed -i 's| console=hvc0| xencons=hvc0 console=hvc0|' /boot/grub/menu.lst
update-grub-legacy-ec2

# cleanup
apt-get clean
rm -f /boot/*.bak
rm -f /var/cache/apt/*.bin
rm -f /var/lib/apt/lists/{*_Release*,*_Packages}

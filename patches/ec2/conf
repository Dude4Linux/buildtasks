#!/bin/bash -ex

fatal() { echo "FATAL: $@" 1>&2; exit 1; }

install() {
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get -y \
        -o DPkg::Options::=--force-confdef \
        -o DPkg::Options::=--force-confold \
        install $@
}

install hubclient ebsmount

# grub tweaks
cur=$(grep GRUB_CMDLINE_LINUX_DEFAULT /etc/default/grub | sed "s/.*=\"\(.*\)\"/\1/")
new=$(echo "$cur xencons=hvc0 console=hvc0" | sed "s/^ *//g")
sed -i "/GRUB_CMDLINE_LINUX_DEFAULT=/ s/=.*/=\"$new\"/" /etc/default/grub

sed -i "/GRUB_HIDDEN_TIMEOUT=/ s/=.*/=true/" /etc/default/grub
sed -i "/GRUB_TIMEOUT=/ s/=.*/=0/" /etc/default/grub

chmod -x /etc/grub.d/*
chmod +x /etc/grub.d/40_custom
update-grub
ln -sf /boot/grub/grub.cfg /boot/grub/menu.lst

# make sure images are world readable
chmod 644 /var/lib/inithooks/turnkey-init-fence/htdocs/*.png


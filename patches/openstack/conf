#!/bin/sh -ex

install() {
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get -y \
        -o DPkg::Options::=--force-confdef \
        -o DPkg::Options::=--force-confold \
        install $@
}

# support hot-plugging of attached volumes
echo "acpiphp" >> /etc/modules

# replace kernel, install openstack required packages
mv /usr/sbin/update-grub /usr/sbin/update-grub.orig
ln -s /bin/true /usr/sbin/update-grub

install linux-image-xen-686 libc6-xen ebsmount
dpkg --purge $(dpkg-query --showformat='${Package}\n' -W '*-686' | grep -v xen)

rm /usr/sbin/update-grub
mv /usr/sbin/update-grub.orig /usr/sbin/update-grub

# hold kernel (not used in image, pro-longs sec-updates)
echo "linux-image-xen-686 hold" | dpkg --set-selections


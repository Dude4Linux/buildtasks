Usage (from backup)
===================

export HUB_APIKEY=.... # smp
hub-launch BACKUP_ID

ssh root@$FQDN

cd /root/buildtasks
./bt-maintenance [--publish] core
./bt-s3 core
./bt-ebs core
...

Note: see cloudtasks for batch building

Setting up buildtasks server / backup on EC2 (from scratch)
===========================================================

FQDN=bt-us-east.tklapp.com

export HUB_APIKEY=.... # smp
hub-launch core --region=us-east-1 --label=BT_USEAST --fqdn=$FQDN

ssh root@$FQDN

/etc/init.d/shellinabox stop
/etc/init.d/webmin stop

sed -i "/multiverse/ s/# //g" /etc/apt/sources.list.d/*.list

export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get -y install tklpatch bzip2 qemu parted kpartx zip
apt-get -y install openjdk-6-jre-headless curl libopenssl-ruby ruby

# workaround weird kpartx bug
modprobe dm-mod

# setup installs
mkdir -p /root/installs
cd /root/installs
wget http://s3.amazonaws.com/ec2-downloads/ec2-ami-tools.zip
wget http://s3.amazonaws.com/ec2-downloads/ec2-api-tools.zip
unzip ec2-ami-tools.zip
unzip ec2-api-tools.zip
rm ec2-ami-tools.zip
rm ec2-api-tools.zip

# ovftool
copy over ovftool installation and install, then remove installation
echo /etc/vmware-vix >> /etc/tklbam/overrides
echo /etc/vmware-installer >> /etc/tklbam/overrides
echo /etc/vmware >> /etc/tklbam/overrides
echo /usr/lib/vmware-installer >> /etc/tklbam/overrides
echo /usr/lib/vmware-ovftool >> /etc/tklbam/overrides
echo /usr/bin/vmware-installer >> /etc/tklbam/overrides
echo /usr/bin/ovftool >> /etc/tklbam/overrides
echo /tmp/vmware-root >> /etc/tklbam/overrides
echo /var/log/vmware-installer >> /etc/tklbam/overrides

# create tklbam hook
BT_HOOK=/etc/tklbam/hooks.d/buildtasks
cat >$BT_HOOK<<EOF
#!/bin/bash -e
# hooks are always called with two arguments
op=$1       # backup / restore
state=$2    # pre / post

if [ "$op" == "restore" ] && [ "$state" == "post" ]; then
    /etc/init.d/shellinabox stop || true
    /etc/init.d/webmin stop || true
fi
EOF
chmod +x $BT_HOOK

# make sure we don't backup sensitive files
echo -/root/buildtasks >> /etc/tklbam/overrides
echo -/root/tklbam-profiles >> /etc/tklbam/overrides

# and finally, perform the backup
tklbam-backup


#!/bin/bash -e
# depends on ec2-ami-tools

fatal() { echo "FATAL [$(basename $0)]: $@" 1>&2; exit 1; }
info() { echo "INFO [$(basename $0)]: $@"; }

usage() {
cat<<EOF
Syntax: $0 rootfs ami_name
Copy ami from source bucket to destination bucket
Bundles rootfs into an s3 ami ready for upload

Arguments::

    bucket_src      - source bucket to copy ami from
    bucket_dst      - destination bucket to copy ami to
    ami_name        - name of the ami

Environment::

    REGION          - Amazon region ($REGION)
    KERNEL          - Amazon kernel ID ($KERNEL)
    EC2_CERT        - Amazon X509 certificate path ($EC2_CERT)
    EC2_PRIVATE_KEY - Amazon X509 private-key path ($EC2_PRIVATE_KEY)
EOF
exit 1
}

if [[ "$#" != "3" ]]; then
    usage
fi

bucket_src=$1
bucket_dst=$2
ami_name=$3

[ -n "$REGION" ] || fatal "REGION not set"
[ -n "$KERNEL" ] || fatal "KERNEL not set"
[ -f "$EC2_CERT" ] || fatal "EC2_CERT not set or does not exist"
[ -f "$EC2_PRIVATE_KEY" ] || fatal "EC2_PRIVATE_KEY not set or does not exist"

case "$REGION" in
    "us-east-1") export location="US" ;;
    "eu-west-1") export location="EU" ;;
    *)           export location=$REGION ;;
esac

info "migrating $ami_name to $bucket_dst"
ec2-migrate-image \
    --cert $EC2_CERT --privatekey $EC2_PRIVATE_KEY \
    --bucket $bucket_src --destination-bucket $bucket_dst \
    --manifest $ami_name.manifest.xml --location $location \
    --kernel $KERNEL --region=$REGION


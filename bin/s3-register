#!/bin/bash -e
# depends on ec2-ami-tools, ec2-api-tools

fatal() { echo "FATAL [$(basename $0)]: $@" 1>&2; exit 1; }
info() { echo "INFO [$(basename $0)]: $@"; }

usage() {
cat<<EOF
Syntax: $0 ami_name
Register AMI

Arguments::

    ami_name        - AMI to register

Environment::

    REGION          - Amazon region ($REGION)
    BUCKET          - Bucket of stored AMI ($BUCKET)
    EC2_CERT        - Amazon X509 certificate path ($EC2_CERT)
    EC2_PRIVATE_KEY - Amazon X509 private-key path ($EC2_PRIVATE_KEY)
EOF
exit 1
}

if [[ "$#" != "1" ]]; then
    usage
fi

[ -n "$REGION" ] || fatal "REGION not set"
[ -n "$BUCKET" ] || fatal "BUCKET not set"
[ -f "$EC2_CERT" ] || fatal "EC2_CERT not set or does not exist"
[ -f "$EC2_PRIVATE_KEY" ] || fatal "EC2_PRIVATE_KEY not set or does not exist"

ami_name=$1

appname=$(echo $ami_name | sed 's|turnkey-\(.*\)-\(.*\)-\(.*\)-\(.*\)|\1|')
[ -n "$appname" ] || fatal "could not determine appname"

info "registering ami ($BUCKET/$ami_name.manifest.xml)"
ec2-register --region=$REGION $BUCKET/$ami_name.manifest.xml \
    --name "$ami_name" --description "http://www.turnkeylinux.org/$appname"


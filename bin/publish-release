#!/bin/bash -e

fatal() {
    echo "FATAL [$(basename $0)]: $@" 1>&2
    exit 1
}

usage() {
cat<<EOF
Syntax: $0 file...fileN
Publish files to PUBLISH_DEST while setting up release directory structure

Arguments::

    file            - similar to turnkey-appname-version[-foo].bar
    release dir     - turnkey-appname/version/file

Environment::

    BT_CONFIG       - buildtasks config directory
    PUBLISH_DEST    - rsync destination (user@fqdn:/path)

    NO_COPY_SSHCONF - if set will not copy ssh client configuration files
EOF
exit 1
}

if [[ "$#" < "1" ]]; then
    usage
fi

[ -n "$BT_CONFIG" ] || fatal "BT_CONFIG not set"
[ -n "$PUBLISH_DEST" ] || fatal "PUBLISH_DEST not set"

[ -n "$NO_COPY_SSHCONF" ] || cp $BT_CONFIG/ssh/* ~/.ssh/

tmpdir=$(mktemp -d --tmpdir=$(dirname $1))

for f in $*; do
    file=$(basename $f)
    appname=$(echo $file |sed 's/turnkey-\(.*\)-[0-9].*/\1/')
    version=$(echo $file |perl -pe \
        's/-(vmdk|ovf|xen)//g; \
         s/\.sig$//; s/\.(zip|iso|tar\.bz2|tar\.gz|changelog|manifest)$//; \
         s/.*?-(\d.*)/\1/')

    mkdir -p $tmpdir/turnkey-$appname/$version
    ln $f $tmpdir/turnkey-$appname/$version
done

set +e
cd $tmpdir
while true; do
    rsync -Pav ./ $PUBLISH_DEST && break

    echo "autoresume rsync: sleeping for 5 seconds"
    sleep 5
done

rm -rf $tmpdir

